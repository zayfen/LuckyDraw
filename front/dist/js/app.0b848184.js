(function(t){function e(e){for(var n,o,r=e[0],c=e[1],u=e[2],d=0,h=[];d<r.length;d++)o=r[d],Object.prototype.hasOwnProperty.call(i,o)&&i[o]&&h.push(i[o][0]),i[o]=0;for(n in c)Object.prototype.hasOwnProperty.call(c,n)&&(t[n]=c[n]);l&&l(e);while(h.length)h.shift()();return a.push.apply(a,u||[]),s()}function s(){for(var t,e=0;e<a.length;e++){for(var s=a[e],n=!0,r=1;r<s.length;r++){var c=s[r];0!==i[c]&&(n=!1)}n&&(a.splice(e--,1),t=o(o.s=s[0]))}return t}var n={},i={app:0},a=[];function o(e){if(n[e])return n[e].exports;var s=n[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=t,o.c=n,o.d=function(t,e,s){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},o.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(o.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)o.d(s,n,function(e){return t[e]}.bind(null,n));return s},o.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="/";var r=window["webpackJsonp"]=window["webpackJsonp"]||[],c=r.push.bind(r);r.push=e,r=r.slice();for(var u=0;u<r.length;u++)e(r[u]);var l=c;a.push([0,"chunk-vendors"]),s()})({0:function(t,e,s){t.exports=s("56d7")},"01ef":function(t,e,s){},"0f56":function(t,e,s){},1:function(t,e){},10:function(t,e){},11:function(t,e){},12:function(t,e){},13:function(t,e){},14:function(t,e){},2:function(t,e){},3:function(t,e){},"334d":function(t,e,s){},"33e8":function(t,e,s){"use strict";s("46d4")},"359c":function(t,e,s){"use strict";s("c716")},"3c9f":function(t,e,s){"use strict";s("334d")},4:function(t,e){},"46d4":function(t,e,s){},"4ef0":function(t,e,s){},5:function(t,e){},5369:function(t,e,s){},"56d7":function(t,e,s){"use strict";s.r(e);s("e260"),s("e6cf"),s("cca6"),s("a79d");var n=s("a026"),i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"app"}},[s("router-view")],1)},a=[],o=s("2877"),r={},c=Object(o["a"])(r,i,a,!1,null,null,null),u=c.exports,l=s("5c96"),d=s.n(l),h=(s("0fae"),s("b970")),f=(s("157a"),s("8c4f")),p=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"luckydraw",class:[t.context.state===t.context.S_CONFIRM?"luckydraw-confirming":""]},[t._m(0),s("el-row",{staticStyle:{position:"absolute",top:"170px",left:"0",right:"0",bottom:"0"}},[s("el-col",{staticClass:"luckydraw-participant",attrs:{span:6}},[s("h4",{staticClass:"luckydraw-participant__title"},[t._v(" 可参与抽奖人数("+t._s(t.validParticipantList.length)+") ")]),s("lucky-image-grid",{staticClass:"luckydraw-participant__wrapper",attrs:{data:t.validParticipantList}})],1),s("el-col",{staticClass:"luckydraw-main",attrs:{span:12}},[t.context.state===t.context.S_START?s("el-button",{staticClass:"luckydraw-main__button luckydraw-main__start",attrs:{size:"large",round:!0,type:"primary"},on:{click:function(e){return t.onDrawButtonClick(t.context.S_START)}}}):t._e(),t.context.state===t.context.S_DRAWING?s("el-button",{staticClass:"luckydraw-main__button luckydraw-main__drawing",attrs:{size:"large",round:!0,type:"primary"},on:{click:function(e){return t.onDrawButtonClick(t.context.S_DRAWING)}}}):t._e(),t.context.state===t.context.S_CONFIRM?s("el-row",{staticClass:"luckydraw-main__confirm"},[s("el-col",{attrs:{span:12}},[s("el-button",{staticClass:"luckydraw-main__button luckydraw-main__confirm-yes",attrs:{round:!0,type:"primary"},on:{click:t.onConfirmYesButtonClick}},[t._v("抽奖有效")])],1),s("el-col",{attrs:{span:12}},[s("el-button",{staticClass:"luckydraw-main__button luckydraw-main__confirm-no",attrs:{type:"weak",round:!0},on:{click:t.toStartState}},[t._v("抽奖无效")])],1)],1):t._e(),s("el-input",{staticClass:"luckydraw-main__count-input",attrs:{placeholder:"中奖人数",max:t.validParticipantList.length,min:0,disabled:!0},on:{input:t.onCountInputChange},model:{value:t.context.numLuckyPeople,callback:function(e){t.$set(t.context,"numLuckyPeople",t._n(e))},expression:"context.numLuckyPeople"}}),t.context.state===t.context.S_START||t.context.state===t.context.S_DRAWING?s("div",{staticClass:"luckydraw-main__hrl"},[s("div",{staticClass:"luckydraw-main__hrl-viewport"},t._l(t.randomParticipantList,(function(e,n){return s("div",{directives:[{name:"show",rawName:"v-show",value:t.context.state===t.context.S_DRAWING,expression:"context.state === context.S_DRAWING"}],key:n,staticClass:"img-bg",style:{backgroundImage:"url("+e.src+")",zIndex:n===t.context.randomIndex%t.randomParticipantList.length?"1":"0"}})})),0),s("span",{directives:[{name:"show",rawName:"v-show",value:t.context.randomIndex>-1,expression:"context.randomIndex > -1"}]},[t._v(" "+t._s(t.randomParticipantList[t.context.randomIndex%t.randomParticipantList.length]&&t.randomParticipantList[t.context.randomIndex%t.randomParticipantList.length].name)+" ")])]):s("lucky-people-display",{staticClass:"luckydraw-main__lpd",attrs:{data:t.context.luckyPeople}})],1),s("el-col",{staticClass:"luckydraw-forbidden",attrs:{span:6}},[s("h4",{staticClass:"luckydraw-forbidden__title"},[t._v("已中奖人数("+t._s(t.forbiddenParticipantList.length)+")")]),s("lucky-image-grid",{staticClass:"luckydraw-forbidden__wrapper",attrs:{data:t.forbiddenParticipantList}})],1)],1),s("div",{staticClass:"lucky-register-qrcode"},[s("lucky-register-qrcode",{attrs:{text:t.qrCodeContent}})],1),s("div",{staticClass:"lucky-checkin"},[s("a",{staticClass:"lucky-checkin-button",attrs:{href:"javascript: void 0;"},on:{click:t.toggleWhiteList}}),s("lucky-white-list",{style:{transform:t.whiteListVisible?"scale(1)":"scale(0)",marginTop:"60px"},attrs:{list:t.participantNameList,session:t.session},on:{changed:t.onWhiteListChanged}})],1),s("div",{staticClass:"luck-session"},[s("a",{staticClass:"luck-session-button",attrs:{href:"javascript: void 0;"},on:{click:t.toggleLuckSessionVisible}},[t._v(" 抽奖会话 ")]),s("luck-board",{staticClass:"luck-board",style:{transform:t.luckSessionVisible?"scale(1)":"scale(0)",marginTop:"60px"},on:{change:t.onLuckSessionChange}})],1)],1)},m=[function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("h2",{staticClass:"title"},[s("span",{staticStyle:{color:"#fcea00"}},[t._v("2021")]),t._v("新年联欢，抽奖现场")])}],k=(s("99af"),s("4de4"),s("4160"),s("a630"),s("caad"),s("c975"),s("d81d"),s("fb6a"),s("a434"),s("b0c0"),s("a9e3"),s("25eb"),s("d3b7"),s("25f0"),s("2532"),s("3ca3"),s("498a"),s("159b"),function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"lucky-image-grid"},[s("div",{staticClass:"grid",class:[{left:"grid-left",center:"grid-center",right:"grid-right"}[t.align]||"center"]},t._l(t.data,(function(e,n){return s("div",{key:n,staticClass:"grid-item",class:[{small:"grid-item__small",normal:"grid-item__normal",large:"grid-item__large"}[t.size]||"normal",t.showname?"grid-item__showname":""]},[s("div",{staticClass:"grid-item__img",style:{backgroundImage:"url("+e.src+")"}}),s("div",{staticClass:"grid-item__container"},[s("h2",[t._v(t._s(e.name))])])])})),0)])}),g=[],v={name:"LuckyImageGrid",props:{data:{type:Array,default:function(){return[]}},align:{type:String,default:"center",validator:function(t){return["left","center","right"].indexOf(t)>-1}},size:{type:String,default:"normal",validator:function(t){return["normal","small","large"].indexOf(t)>-1}},showname:{type:Boolean,default:!1}},data:function(){return{}}},b=v,y=(s("c3e4"),Object(o["a"])(b,k,g,!1,null,"ac904526",null)),w=y.exports,_=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"lucky-register"},[s("img",{attrs:{src:t.qrcodeBase64Data}})])},L=[],S=s("d055"),C=s.n(S);function x(t){return C.a.toDataURL(t,{type:"svg",margin:0,version:6,errorCorrectionLevel:"H",color:{dark:"#000",light:"#FFFFFF"}})}var P={name:"LuckyRegisterQrcode",props:{text:String},data:function(){return{qrcodeBase64Data:""}},created:function(){var t=this;return x(this.text).then((function(e){t.qrcodeBase64Data=e}))}},I=P,D=(s("33e8"),Object(o["a"])(I,_,L,!1,null,"66c7cc76",null)),$=D.exports,T=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"lucky-white-list"},[s("el-card",{attrs:{shadow:"always"}},[s("h5",{staticStyle:{padding:"0",margin:"0",color:"#BD2B24","font-size":"26px"}},[t._v(" 签到表("+t._s(t.tableData.filter((function(e){return t.list.includes(e.name.trim())})).length)+"/"+t._s(t.tableData.filter((function(t){return t.name.trim()})).length)+") ")]),s("el-table",{staticClass:"lucky-white-list__table",staticStyle:{width:"100%"},attrs:{data:t.tableData,"row-class-name":t.tableRowClassName,"empty-text":"签到表为空"}},[s("el-table-column",{attrs:{prop:"name",label:"姓名",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[e.row.editable?s("el-input",{attrs:{autofucus:"true",placeholder:"请输入姓名"},model:{value:e.row.name,callback:function(s){t.$set(e.row,"name",s)},expression:"scope.row.name"}}):s("span",{staticClass:"user-name",on:{dblclick:function(t){e.row.editable=!0}}},[t._v(t._s(e.row.name))])]}}])}),s("el-table-column",{attrs:{prop:"status",label:"状态",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[t.list.includes(e.row.name.trim())?s("i",{staticClass:"el-icon-circle-check",attrs:{color:"green"}}):s("i",{staticClass:"el-icon-circle-close"}),s("span",[t._v(t._s(t.list.includes(e.row.name.trim())?"已签到":"未签到"))])]}}])}),s("el-table-column",{attrs:{label:"操作",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("el-button",{attrs:{size:"mini",type:"primary"},on:{click:function(s){return t.edit(e.$index,e.row)}}},[t._v(t._s(e.row.editable?"确定":"修改"))]),s("el-button",{attrs:{size:"mini",type:"weak"},on:{click:function(s){return t.deleteRow(e.$index,e.row)}}},[t._v("删除")])]}}])})],1),s("el-button",{staticStyle:{margin:"10px auto"},attrs:{type:"primary",icon:"el-icon-circle-plus-outline"},on:{click:t.addWhiteItem}},[t._v("添加")])],1)],1)},N=[],j=s("d4ec"),O=s("bee2"),z=s("bc3a"),F=s.n(z),R=F.a.create({timeout:5e3,withCredentials:!0});function B(){}R.interceptors.response.use((function(t){return t}),(function(t){return Promise.reject(t)})),B.prototype.get=function(t,e){var s=e||{};return new Promise((function(e,n){return R.get(t,{params:s}).then((function(t){e(t.data)})).catch((function(t){n(t)}))}))},B.prototype.post=function(t,e,s){var n=e||{};return new Promise((function(e,i){R.post(t,n,s).then((function(t){e(t.data)})).catch((function(t){i(t)}))}))};var W=new B;function M(t){return"/api/"+t}function A(t){return window.WebSocket?new window.WebSocket(t):window.MozWebSocket?new window.MozWebSocket(t):null}var E=function(){function t(){Object(j["a"])(this,t)}return Object(O["a"])(t,null,[{key:"register",value:function(t,e,s){var n=M("register");return W.post(n,{avatar:e,name:t,session:s})}},{key:"syncUser",value:function(t,e,s,n){var i=window.location.host,a="ws://"+i+"/syncUser?session="+t,o=A(a);if(null===o)throw Error("Browser dont support websocket");o.onopen=function(t){"function"===typeof e&&e(t)},o.onmessage=function(t){"function"===typeof s&&s(t)},o.onclose=function(t){"function"===typeof n&&n(t)}}},{key:"checkinList",value:function(t){var e=M("checkinList");return W.post(e,{session:t})}},{key:"upsertCheckinList",value:function(t,e){var s=M("upsertCheckinList");return W.post(s,{session:t,users:e})}},{key:"upsertLuckSession",value:function(t){var e=t.session,s=t.prizes,n=t.count,i=t.startTime,a=t.luckId,o=M("upsertLuckSession");return W.post(o,{session:e,prizes:s,count:n,startTime:i,luckId:a})}},{key:"deleteLuckSession",value:function(t){var e=M("deleteLuckSession");return W.post(e,{luckId:t})}},{key:"fetchLuckSessions",value:function(t){var e=M("getLucks");return W.get(e,{session:t})}},{key:"commitLuckyPeople",value:function(t){var e=t.session,s=t.luckId,n=t.people,i=M("saveLuckyPeople");return W.post(i,{session:e,luckId:s,people:n})}},{key:"fetchUsers",value:function(t){var e=M("sessions/".concat(t,"/users"));return W.get(e)}}]),t}(),q=E,V={name:"LuckyWhiteList",props:{session:{type:String,required:!0},list:{type:Array,default:function(){return[]}}},data:function(){return{tableData:[]}},watch:{tableData:function(t,e){this.notifyWhiteListChange()}},created:function(){this.loadCheckinList()},methods:{tableRowClassName:function(t){var e=t.row;return this.list.includes(e.name.trim())?"checkin-status__yes":"checkin-status__no"},addWhiteItem:function(){this.tableData.push({name:"",editable:!0})},notifyWhiteListChange:function(){this.$emit("changed",this.tableData)},edit:function(t,e){e.editable=!e.editable,e.editable||(this.notifyWhiteListChange(),this.saveCheckinList())},deleteRow:function(t){this.tableData.splice(t,1),this.saveCheckinList()},saveCheckinList:function(){var t=this,e=[];this.tableData.forEach((function(t){return e.push(t.name)})),q.upsertCheckinList(this.session,e).then((function(e){0===e.code?t.$message({message:"签到表更新成功",type:"success"}):t.$message({message:"签到表更新失败",type:"error"})}))},loadCheckinList:function(){var t=this;q.checkinList(this.session).then((function(e){if(0===e.code){var s=e.data;s.forEach((function(e){return t.tableData.push({name:e,editable:!1})}))}else console.error("Api.checkinList error: ",e.message)})).catch((function(e){console.error("Api.checkinList error: ",e),t.$message({message:"签到表拉取失败",type:"error"})}))}}},U=V,G=(s("8db3"),s("3c9f"),Object(o["a"])(U,T,N,!1,null,"13242f13",null)),H=G.exports,J=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"lucky-people-display"},[s("span",{staticClass:"lucky-people-display__title"},[t._v("中奖名单")]),s("div",{staticClass:"grid"},t._l(t.data,(function(e,n){return s("div",{key:n,staticClass:"grid-item"},[s("div",{staticClass:"grid-item__avatar",style:{backgroundImage:["url(",e.src,")"].join("")}}),s("span",{staticClass:"grid-item__name"},[t._v(t._s(e.name))])])})),0)])},Y=[],Q={name:"LuckyPeopleDisplay",props:{data:{type:Array,default:function(){return[]}}}},K=Q,X=(s("6668"),Object(o["a"])(K,J,Y,!1,null,"68a505ad",null)),Z=X.exports,tt=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"luck-board"},[t._m(0),s("div",{staticClass:"luck-board-sessions"},[s("el-table",{staticClass:"luck-board-table",attrs:{data:t.sessionsData,"empty-text":"还没有创建抽奖会话"}},[t._l(t.sessionsSchema,(function(t,e){return s("el-table-column",{key:e,attrs:{label:t.label,prop:t.prop,formatter:t.formatter}})})),s("el-table-column",{attrs:{label:"操作",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("el-button",{attrs:{size:"mini",type:"primary"},on:{click:function(s){return t.edit(e.$index,e.row)}}},[t._v("修改")]),s("el-button",{attrs:{size:"mini",type:"weak"},on:{click:function(s){return t.deleteRow(e.$index,e.row)}}},[t._v("删除")])]}}])})],2)],1),t.showCreateButton?s("el-button",{staticStyle:{position:"absolute",top:"0",right:"30px","margin-top":"20px"},attrs:{type:"primary",size:"small"},on:{click:t.toggleLuckSessionForm}},[t._v(" 添加新的抽奖 ")]):t._e(),s("el-dialog",{attrs:{title:"创建新的抽奖","modal-append-to-body":!1,"before-close":t.toggleLuckSessionForm,visible:t.formVisible},on:{"update:visible":function(e){t.formVisible=e}}},[s("el-form",{ref:"formRef",staticClass:"form-new-session",attrs:{model:t.sessionForm}},[s("el-form-item",{attrs:{label:"奖品描述"}},[s("el-input",{model:{value:t.sessionForm.prizes,callback:function(e){t.$set(t.sessionForm,"prizes",e)},expression:"sessionForm.prizes"}})],1),s("el-form-item",{attrs:{label:"奖品数量"}},[s("el-input",{model:{value:t.sessionForm.count,callback:function(e){t.$set(t.sessionForm,"count",t._n(e))},expression:"sessionForm.count"}})],1),s("el-form-item",{attrs:{label:"开始时间"}},[s("el-time-picker",{staticStyle:{width:"100%"},attrs:{type:"datetime","value-format":"timestamp"},model:{value:t.sessionForm.startTime,callback:function(e){t.$set(t.sessionForm,"startTime",e)},expression:"sessionForm.startTime"}})],1),s("el-form-item",[s("el-button",{attrs:{type:"primary"},on:{click:t.upsertLuckSession}},[t._v(" "+t._s(t.sessionForm.luckId?"更新":"创建")+" ")]),s("el-button",{on:{click:t.cancel}},[t._v("取消")])],1)],1)],1)],1)},et=[function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"luck-board-title"},[s("span",[t._v("抽奖会话列表")])])}],st=(s("7db0"),s("a15b"),{name:"LuckBoard",props:{showCreateButton:{type:Boolean,required:!1,default:!0}},data:function(){var t=this;return{luckyPeople:[],sessionsData:[],sessionsSchema:[{label:"奖品描述",prop:"prizes"},{label:"奖品数量",prop:"count"},{label:"抽奖时间",prop:"startTime",formatter:function(t,e,s){var n=new Date(s);return[n.getFullYear(),n.getMonth()+1,n.getDate()].join("/")+"  "+[n.getHours(),n.getMinutes(),n.getSeconds()].join(":")}},{label:"中奖人员",formatter:function(e,s,n){var i=e.luckId,a=t.luckyPeople.find((function(t){return t.luckId===i}));return a?a.users.join(","):"-"}},{label:"抽奖会话状态",prop:"startTime",formatter:function(e,s,n){var i=e.finished;return i?"已结束":n===t.currentLuckSession.startTime?"进行中":"未开始"}}],formVisible:!1,sessionForm:{prizes:"",count:"",startTime:""},session:this.$route.query.session}},computed:{currentLuckSession:function(){var t=this.sessionsData.filter((function(t){return!t.finished}));return t.sort((function(t,e){return t.startTime-e.startTime})),t[0]}},created:function(){this.session?this.requestLuckSessions():this.$message.error("URL中请指定session")},methods:{edit:function(t,e){var s=this;if(e.finished)return this.$message.error("禁止修改已结束的抽奖");this.toggleLuckSessionForm(),this.sessionForm=e,q.upsertLuckSession(this.sessionForm).then((function(t){0===t.code?(s.$message.success("修改成功"),s.requestLuckSessions()):s.$message.error(t.message||"修改失败")})).catch((function(t){s.$message.error(t||"修改失败")}))},deleteRow:function(t,e){var s=this;if(e.finished)return this.$message.error("禁止删除已结束的抽奖");q.deleteLuckSession(e.luckId).then((function(t){0===t.code?(s.$message.success("删除成功"),s.requestLuckSessions()):s.$message.error(t.message||"删除失败")})).catch((function(t){s.$message.error(t||"删除失败")}))},toggleLuckSessionForm:function(){this.formVisible=!this.formVisible,this.formVisible||(this.sessionForm={prizes:"",count:"",startTime:""})},requestLuckSessions:function(){var t=this;q.fetchLuckSessions(this.session).then((function(e){0===e.code&&(t.sessionsData=e.data.luckSessions,t.luckyPeople=e.data.luckyPeople,t.emitCurrentLuckSession()),setTimeout(t.requestLuckSessions.bind(t),2e3)})).catch((function(e){setTimeout(t.requestLuckSessions.bind(t),3e3)}))},upsertLuckSession:function(){var t=this;if(!this.sessionForm.prizes||!this.sessionForm.count||!this.sessionForm.startTime)return this.$message.error("请填写合法的表单");q.upsertLuckSession({session:this.session,prizes:this.sessionForm.prizes,count:this.sessionForm.count,startTime:this.sessionForm.startTime,luckId:this.sessionForm.luckId}).then((function(e){0===e.code&&(t.$message.success(t.sessionForm.luckId?"修改成功":"创建成功"),t.requestLuckSessions())})).catch((function(e){t.$message.error(e.message)}))},emitCurrentLuckSession:function(){this.$emit("change",this.currentLuckSession)},cancel:function(){this.$refs["formRef"].resetFields(),this.toggleLuckSessionForm()}}}),nt=st,it=(s("f089"),s("65ea"),Object(o["a"])(nt,tt,et,!1,null,"53640355",null)),at=it.exports,ot=s("11a1");function rt(){var t=new ot["a"];return function(e,s){return t.integer(e,s)}}var ct=rt(),ut={components:{LuckyImageGrid:w,LuckyRegisterQrcode:$,LuckyWhiteList:H,LuckyPeopleDisplay:Z,LuckBoard:at},data:function(){return{participantList:[{session:"2021",name:"张云峰",src:"https://cdn.dribbble.com/users/2076798/screenshots/14007967/media/22cd0a660328ff5593cecdb58491c770.jpg?compress=1&resize=400x300",forbidden:!1},{session:"2021",name:"张三",src:"https://cdn.dribbble.com/users/2076798/screenshots/14007967/media/22cd0a660328ff5593cecdb58491c770.jpg?compress=1&resize=400x300",forbidden:!1},{session:"2021",name:"张云峰2",src:"https://cdn.dribbble.com/users/2076798/screenshots/14007967/media/22cd0a660328ff5593cecdb58491c770.jpg?compress=1&resize=400x300",forbidden:!1},{session:"2021",name:"张三2",src:"https://cdn.dribbble.com/users/2076798/screenshots/14007967/media/22cd0a660328ff5593cecdb58491c770.jpg?compress=1&resize=400x300",forbidden:!1}],session:"",whiteListVisible:!1,whiteList:[],context:{S_START:"start",S_DRAWING:"drawing",S_CONFIRM:"confirm",numLuckyPeople:0,state:"start",randomIndex:-1,luckyPeople:[],proposalLuckyPeopleIndexes:[]},luckSessionVisible:!1,currentLuckSession:{}}},computed:{qrCodeContent:function(){var t=function(t){return!("NaN"===Number.parseInt(t).toString())},e=this.$route.query.interval||"",s=window.location.protocol,n=window.location.host,i="".concat(s,"//").concat(n,"/register?session=").concat(this.session);return e&&t(e)&&(i="".concat(i,"&interval=").concat(e)),i},randomParticipantList:function(){var t=Math.min(20,this.validParticipantList.length);return this.validParticipantList.slice(0,t)},validParticipantList:function(){return this.checkedParticipantList.filter((function(t){return!t.forbidden}))},forbiddenParticipantList:function(){return this.checkedParticipantList.filter((function(t){return t.forbidden}))},checkedParticipantList:function(){var t=this;return this.participantList.filter((function(e){return t.whiteList.indexOf(e.name.trim())>-1}))},participantNameList:function(){return this.participantList.map((function(t){return t.name}))}},created:function(){this.session=this.$route.query.session||""+Date.now()},mounted:function(){q.syncUser(this.session,this.onWebSocketOpen.bind(this),this.onWebSocketMessage.bind(this),this.onWebSocketClose.bind(this)),window.addEventListener("beforeunload",(function(t){return t=t||window.event,t&&(t.returnValue="确定离开抽奖页面吗？"),"确定离开抽奖页面吗？"}))},methods:{onWebSocketOpen:function(){console.log("onWebSocketOpen")},onWebSocketMessage:function(t){if(t.data.length<=1)console.log("keep-alive heartbeat ",t.data);else{var e=JSON.parse(t.data);if(console.log("onWebSocketMessage Data: ",t.data),"AllUsers"===e.action){var s=this.loadLuckyNamesLocal();this.participantList=e.data.map((function(t){return{session:t.session,name:t.user.trim(),src:t.avatar,forbidden:s.indexOf(t.user.trim())>-1}}))}if("NewUser"===e.action){var n=this.whiteList.includes(e.data.user.trim());n?this.$message({message:e.data.user+" 签到成功",type:"success"}):this.$message({message:e.data.user+"(外部人员) 扫码加入",type:"warning"}),this.participantList.splice(0,0,{session:e.data.session,name:e.data.user,src:e.data.avatar,forbidden:!1})}}},onWebSocketClose:function(){console.log("onWebSocketClose")},toNextState:function(){var t={start:this.toDrawingState.bind(this),drawing:this.toConfrimState.bind(this),confirm:this.toStartState.bind(this)};t[this.context.state]()},toStartState:function(){this.context.state=this.context.S_START,this.context.numLuckyPeople=1,this.context.randomIndex=-1,this.context.luckyPeople.splice(0,this.context.luckyPeople.length),this.context.proposalLuckyPeopleIndexes.splice(0,this.context.proposalLuckyPeopleIndexes.length)},toDrawingState:function(){this.context.state=this.context.S_DRAWING,this.validParticipantList.length<=0||this.context.numLuckyPeople<1||this.startDrawing()},toConfrimState:function(){var t=this;this.context.state=this.context.S_CONFIRM,this.context.proposalLuckyPeopleIndexes.forEach((function(e){setTimeout((function(){t.context.luckyPeople.push(t.validParticipantList[e])}),500)}))},onDrawButtonClick:function(){this.validParticipantList.length<=0||this.context.numLuckyPeople<1||this.toNextState()},onConfirmYesButtonClick:function(){var t=this,e=[];this.context.luckyPeople.forEach((function(s){e.push(s.name),Array.from({length:t.participantList.length}).forEach((function(e,n){var i=t.participantList[n];i.name===s.name&&(i.forbidden=!0,t.participantList.splice(n,1,i))}))})),e.length>0&&this.commitLuckyPeople(e),this.saveLuckyNamesLocal(),this.toNextState()},startDrawing:function(){var t=this;requestAnimationFrame((function(){var e=t.generateRandomIndexes(t.context.numLuckyPeople);t.context.randomIndex=e[0]||0,t.context.state===t.context.S_DRAWING?t.startDrawing():t.context.randomIndex=t.context.proposalLuckyPeopleIndexes[0]||0}))},generateRandomIndexes:function(t){var e=this.validParticipantList.length,s=this._.cloneDeep(this.validParticipantList);s=s.map((function(t,e){return t.index=e,t})),t=Math.min(t,e),this.context.proposalLuckyPeopleIndexes.splice(0,this.context.proposalLuckyPeopleIndexes.length);while(this.context.proposalLuckyPeopleIndexes.length<t){var n=ct(0,s.length-1);this.context.proposalLuckyPeopleIndexes.push(s[n].index),s.splice(n,1)}return this.context.proposalLuckyPeopleIndexes},toggleWhiteList:function(){console.log("toggle white list"),this.whiteListVisible=!this.whiteListVisible,this.whiteListVisible&&(this.luckSessionVisible=!1)},onWhiteListChanged:function(t){var e=this;this.whiteList.splice(0,this.whiteList.length),t.map((function(t){return t.name})).forEach((function(t){return e.whiteList.push(t)}))},onCountInputChange:function(t){t>this.validParticipantList.length&&(this.context.numLuckyPeople=this.validParticipantList.length),t<1&&(this.context.numLuckyPeople=Math.min(1,this.validParticipantList.length))},saveLuckyNamesLocal:function(){var t=this.forbiddenParticipantList.map((function(t){return t.name}))||[],e=this.session+"-lucky-names";localStorage.setItem(e,JSON.stringify(t))},loadLuckyNamesLocal:function(){var t=this.session+"-lucky-names",e=localStorage.getItem(t)||JSON.stringify([]);return JSON.parse(e)},toggleLuckSessionVisible:function(){this.luckSessionVisible=!this.luckSessionVisible,this.luckSessionVisible&&(this.whiteListVisible=!1)},onLuckSessionChange:function(t){this.currentLuckSession=t,this.context.numLuckyPeople=this.currentLuckSession?this.currentLuckSession.count:0},commitLuckyPeople:function(t){var e=this,s=this.currentLuckSession.session,n=this.currentLuckSession.luckId;q.commitLuckyPeople({session:s,luckId:n,people:t}).then((function(t){0===t.code?e.$message.success("中奖信息保存成功"):e.$message.error("中奖信息保存失败(".concat(t.code,")"))}))}}},lt=ut,dt=(s("e560"),s("eabb"),Object(o["a"])(lt,p,m,!1,null,"0c8b0207",null)),ht=dt.exports,ft=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"register"},[s("p",{staticClass:"title"},[t._v("瓶子科技2021年会抽奖")]),s("van-row",{attrs:{type:"flex",justify:"center"}},[s("van-col",{attrs:{span:8}},[s("van-uploader",{attrs:{"after-read":t.afterRead}},[s("van-button",{staticClass:"upload-face-button",attrs:{plain:"",type:"primary"}},[t._v("上传人脸")])],1)],1)],1),s("van-image",{staticStyle:{"margin-top":"1rem",overflow:"hidden"},attrs:{src:t.avatar,width:"8rem",height:"8rem",round:"",fit:"cover"}}),s("van-row",{staticClass:"form"},[s("van-field",{attrs:{label:"用户名:",placeholder:"请输入姓名"},model:{value:t.userName,callback:function(e){t.userName=e},expression:"userName"}})],1),s("van-row",{staticClass:"submit-button",attrs:{type:"flex",justify:"center"}},[s("van-col",{attrs:{span:"20"}},[s("van-button",{attrs:{type:"primary",size:"large"},on:{click:t.register}},[t._v("参与抽奖")])],1)],1),s("van-loading",{directives:[{name:"show",rawName:"v-show",value:t.loading,expression:"loading"}],staticClass:"toast-loading",attrs:{size:"24px"}},[t._v("请求中...")]),s("van-loading",{directives:[{name:"show",rawName:"v-show",value:t.uploading,expression:"uploading"}],staticClass:"toast-loading",attrs:{size:"24px"}},[t._v("图片上传中...")]),t.success?s("div",{staticClass:"register-success"},[s("p",{staticClass:"register-success__title-head"},[t._v("恭喜")]),s("p",{staticClass:"register-success__title-body"},[t._v("参与成功")])]):t._e()],1)},pt=[],mt=s("f564"),kt=(s("ddb0"),s("2b3d"),s("6f45"));function gt(t){return new Promise((function(e,s){var n=new Image;n.src=window.URL.createObjectURL(t),n.onload=function(){kt["getData"](n,(function(){var t=kt["getTag"](this,"Orientation"),s=document.createElement("canvas"),i=s.getContext("2d");switch(t){case 3:s.width=n.width,s.height=n.height,i.rotate(180*Math.PI/180),i.drawImage(n,-n.width,-n.height,n.width,n.height);break;case 6:s.width=n.height,s.height=n.width,i.rotate(90*Math.PI/180),i.drawImage(n,0,-n.height,n.width,n.height);break;case 8:s.width=n.height,s.height=n.width,i.rotate(-90*Math.PI/180),i.drawImage(n,-n.width,0,n.width,n.height);break;default:s.width=n.width,s.height=n.height,i.drawImage(n,0,0,n.width,n.height);break}s.toBlob((function(t){if(/\/(?:jpeg|png|jpg|gif)/i.test(t.type)&&t.size>1e6){var n=document.createElement("canvas"),i=n.getContext("2d"),a=new Image;return a.src=URL.createObjectURL(t),void(a.onload=function(){var t=a.height/a.width;n.width=800,n.height=800*t,i.drawImage(a,0,0,n.width,n.height),n.toBlob((function(t){e({content:n.toDataURL("image/jpeg",.92),file:t})}))})}e({content:s.toDataURL("image/jpeg",.92),file:t})}),"image/jpeg",.92)}))}}))}function vt(t,e){return new Promise((function(t){var s="/api/minio/presignedUrl",n=(new Date).getTime()+Math.random().toString(36).substr(2)+Math.random().toString(36).substr(2);F.a.get(s,{params:{name:n}}).then((function(s){console.log("upload.get res: ",s),F.a.put(s.data.data.url,e).then((function(e){console.log("put.put res: ",e),200===e.status?t({code:0,data:{visit_url:s.data.data.visit_url}}):t({code:-1,message:"error"})}))}))}))}var bt="key-session-history-of-luckdraw",yt=2880,wt={data:function(){return{userName:"",avatar:"",session:"",intervalMinutes:yt,loading:!1,uploading:!1,success:!1}},computed:{FormDisabled:function(){return!(this.userName&&this.avatar)}},created:function(){this.session=this.$route.query.session||"0",this.intervalMinutes=Number.parseInt(this.$route.query.interval||yt)},methods:{validateAndSaveSession:function(){var t=this.sessionHistory(),e=t[this.session],s={id:this.session,intervalMs:60*this.intervalMinutes*1e3,updateTimestamp:Date.now()};return!!this.preSessionExpired(e,s)&&(t[this.session]=s,localStorage.setItem(bt,JSON.stringify(t)),!0)},clearSession:function(){localStorage.removeItem(bt)},preSessionExpired:function(t,e){if(!t)return!0;var s=e.updateTimestamp-t.updateTimestamp;return s>t.intervalMs},sessionHistory:function(){var t=localStorage.getItem(bt)||"{}";return JSON.parse(t)},register:function(){var t=this;if(!this.userName||!this.avatar||!this.session){var e=[];return!this.userName.trim()&&e.push("姓名"),!this.avatar.trim()&&e.push("图像"),this.toast(e.join("、")+"必填","danger")}if(this.loading)return this.toast("已在请求中","danger");this.loading=!0,q.register(this.userName.trim(),this.avatar.trim(),this.session.trim()).then((function(e){t.loading=!1,0===e.code?(t.toast("参加成功"),t.success=!0):11e3===e.code?t.toast("此用户名已参加","warning"):t.toast(e.message||"参加失败，请稍后重试","warning")})).catch((function(e){t.toast(e||"网络或者服务器异常","danger"),t.loading=!1}))},afterRead:function(t){var e=this;gt(t.file).then((function(t){e.uploading=!0,vt("img",t.file).then((function(t){e.uploading=!1,0===t.code?e.avatar=t.data.visit_url:e.toast(t.message||"上传人脸图片失败","danger")})).catch((function(t){e.uploading=!1,e.toast(t||"上传人脸图片失败","danger")}))}))},toast:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success";Object(mt["a"])({type:e,message:t})}}},_t=wt,Lt=(s("cde2"),Object(o["a"])(_t,ft,pt,!1,null,"a4980506",null)),St=Lt.exports,Ct=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"page"},[s("div",{staticClass:"draw-luck"},[s("div",{staticClass:"draw-luck-title luck-title"},[t._v(" 当前奖品 ")]),t.currentLuckSession?s("div",{staticClass:"draw-luck-prize"},[t._v(" "+t._s(t.currentLuckSession.prizes)+" "),s("span",{staticStyle:{margin:"0 0.3rem",color:"#ffd790"}},[t._v("x")]),t._v(" "+t._s(t.currentLuckSession.count)+" ")]):s("div",{staticClass:"draw-luck-prize"},[t._v(" 暂无抽奖 ")]),t._e(),s("div",{staticClass:"progress"},[s("div",{staticClass:"progress-inner",style:{width:t.progressValue+"%"}})]),s("div",{staticClass:"luck-button",class:[t.currentLuckSession?"breath":""],style:t.luckButtonStyle,on:{click:t.onLuckButtonClick}}),s("div",{staticClass:"luckypeople-table"},[s("span",{staticClass:"luckypeople-table-title luck-title"},[t._v(" 中奖名单 ")]),s("div",{staticClass:"luck-table"},[t._m(0),s("div",{staticClass:"luck-table-body"},t._l(t.allLucks,(function(e,n){return s("div",{key:n,staticClass:"row"},[s("div",{staticClass:"col"},[t._v(t._s(e.prize))]),s("div",{staticClass:"col"},[t._v(t._s(e.count))]),s("div",{staticClass:"col"},[t._v(t._s(e.owner))])])})),0)])]),s("div",{staticClass:"dialog",class:{"dialog-show":t.newLucks.length>0}},[s("div",{staticClass:"close-button",on:{click:t.updatePreAllLucks}},[s("el-button",{attrs:{type:"danger",icon:"el-icon-circle-close",circle:""}})],1),s("div",{staticClass:"dialog-inner"},[s("div",{staticClass:"luckypeople-table"},[s("span",{staticClass:"luckypeople-table-title luck-title"},[t._v(" 中奖名单 ")]),s("div",{staticClass:"luck-table"},[t._m(1),s("div",{staticClass:"luck-table-body"},t._l(t.newLucks,(function(e,n){return s("div",{key:n,staticClass:"row"},[s("div",{staticClass:"col"},[t._v(t._s(e.prize))]),s("div",{staticClass:"col"},[t._v(t._s(e.count))]),s("div",{staticClass:"col"},[t._v(t._s(e.owner))])])})),0)])])])])])])},xt=[function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"luck-table-head row"},[s("div",{staticClass:"head col"},[t._v("奖品名称")]),s("div",{staticClass:"head col"},[t._v("奖品数量")]),s("div",{staticClass:"head col"},[t._v("中奖名单")])])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"luck-table-head row"},[s("div",{staticClass:"head col"},[t._v("奖品名称")]),s("div",{staticClass:"head col"},[t._v("奖品数量")]),s("div",{staticClass:"head col"},[t._v("中奖名单")])])}],Pt=(s("c740"),s("5530")),It={data:function(){return{session:this.$route.params.session,luckySessions:[],luckyPeople:[],nowTimestamp:Date.now(),allPeopleNames:"",luckButtonClicks:0,luckButtonHandler:0,preAllLucks:[]}},computed:{wordsLoopStyle:function(){var t=this.allPeopleNames.length/40*5;return{animationDuration:"".concat(t,"5s")}},progressValue:function(){return Math.min(this.luckButtonClicks/1.4,100)},luckButtonStyle:function(){if(this.luckButtonClicks<=0)return{animationDuration:"0ms"};var t=2e3,e=t/this.luckButtonClicks;return{animationDuration:"".concat(e,"ms")}},couldDraw:function(){return!!this.currentLuckSession},currentLuckSession:function(){var t=this.luckySessions.filter((function(t){return!t.finished}));return t.sort((function(t,e){return t.startTime-e.startTime})),t[0]},luckSessionStartTime:function(){if(!this.currentLuckSession)return"无";var t=new Date(this.currentLuckSession.startTime);return[t.getFullYear(),t.getMonth()+1,t.getDate()].join("/")+"  "+[t.getHours(),t.getMinutes(),t.getSeconds()].join(":")},allLucks:function(){var t=this,e=this.luckyPeople.map((function(e){var s=t.luckySessions.find((function(t){return t.luckId===e.luckId}));if(s)return Object(Pt["a"])(Object(Pt["a"])({},e),{},{prize:s.prizes})})),s=[];return console.log("allLucks.list: ",e),e.forEach((function(t){null===t||void 0===t||t.users.forEach((function(e){console.log("user: ",e),s.push({prize:t.prize,count:1,owner:e[0]})}))})),console.log("allLucks: ",s),s},newLucks:function(){var t=this;if(this.allLucks.length===this.preAllLucks.allLucks)return[];var e=this.allLucks.filter((function(e){return-1===t.preAllLucks.findIndex((function(t){return t.prize===e.prize&&t.count===e.count&&t.owner===e.owner}))}));return e.slice(0)}},created:function(){this.session?this.requestLuckSessions():this.$message.error("URL中请指定session")},methods:{requestLuckSessions:function(){var t=this;q.fetchLuckSessions(this.session).then((function(e){0===e.code&&(t.luckySessions=e.data.luckSessions,t.luckyPeople=e.data.luckyPeople),setTimeout(t.requestLuckSessions.bind(t),2e3)})).catch((function(e){setTimeout(t.requestLuckSessions.bind(t),3e3)}))},onLuckButtonClick:function(){var t=this;if(!this.couldDraw)return this.$message.error("还没有创建新的抽奖！");this.luckButtonClicks+=1,console.log("luckButtonClicks: ",this.luckButtonClicks),clearTimeout(this.luckButtonHandler),this.luckButtonHandler=setTimeout((function(){t.calmdown()}),250)},calmdown:function(){var t=this;clearTimeout(this.luckButtonHandler),this.luckButtonClicks<5?this.luckButtonClicks=0:(this.luckButtonClicks=.9*this.luckButtonClicks,this.luckButtonHandler=setTimeout((function(){t.calmdown()}),250))},updatePreAllLucks:function(){this.preAllLucks=this.allLucks.slice(0)}}},Dt=It,$t=(s("bf89"),s("359c"),Object(o["a"])(Dt,Ct,xt,!1,null,"12ede7ec",null)),Tt=$t.exports;n["default"].use(f["a"]);var Nt=new f["a"]({mode:"history",base:"/",routes:[{path:"/",name:"index",alias:"/index",component:ht},{path:"/register",name:"register",component:St},{path:"/goodluck/:session",name:"goodluck",component:Tt}]}),jt=s("2ef0"),Ot=s.n(jt);n["default"].config.productionTip=!1,n["default"].use(d.a),n["default"].use(h["a"]),n["default"].prototype._=Ot.a,new n["default"]({router:Nt,render:function(t){return t(u)}}).$mount("#app")},6:function(t,e){},"65ea":function(t,e,s){"use strict";s("8336")},6668:function(t,e,s){"use strict";s("cbba")},7:function(t,e){},"75fb":function(t,e,s){},8:function(t,e){},8336:function(t,e,s){},"8db3":function(t,e,s){"use strict";s("01ef")},9:function(t,e){},ada1:function(t,e,s){},bf89:function(t,e,s){"use strict";s("0f56")},c3e4:function(t,e,s){"use strict";s("ffa0")},c716:function(t,e,s){},cbba:function(t,e,s){},cde2:function(t,e,s){"use strict";s("5369")},e560:function(t,e,s){"use strict";s("ada1")},eabb:function(t,e,s){"use strict";s("75fb")},f089:function(t,e,s){"use strict";s("4ef0")},ffa0:function(t,e,s){}});
//# sourceMappingURL=app.0b848184.js.map